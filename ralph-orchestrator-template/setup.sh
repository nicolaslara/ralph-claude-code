#!/bin/bash
set -e

# Ralph Orchestrator Template Setup
# Usage: ./setup.sh <target-directory> [project-description]
#
# Examples:
#   ./setup.sh ~/devel/my-app "A recipe management mobile app using React Native and Convex"
#   ./setup.sh ~/devel/my-contracts "Solidity smart contracts for a token vesting system"
#   ./setup.sh ~/devel/my-api  # Interactive mode - will prompt for description

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Ralph Orchestrator Template Setup${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Check arguments
if [ -z "$1" ]; then
    print_header
    echo -e "${RED}Error: Target directory required${NC}"
    echo ""
    echo "Usage: $0 <target-directory> [project-description]"
    echo ""
    echo "Examples:"
    echo "  $0 ~/devel/my-app \"A recipe app using React Native\""
    echo "  $0 ~/devel/my-api  # Will prompt for description"
    exit 1
fi

TARGET_DIR="$1"
PROJECT_DESC="$2"

print_header
echo ""

# Check if target exists
if [ -d "$TARGET_DIR" ]; then
    echo -e "${YELLOW}Warning: $TARGET_DIR already exists${NC}"
    read -p "Continue and add template files? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}Creating directory: $TARGET_DIR${NC}"
    mkdir -p "$TARGET_DIR"
fi

# Copy template files (excluding setup files themselves)
echo -e "${GREEN}Copying template files...${NC}"
cp -r "$SCRIPT_DIR/.agent" "$TARGET_DIR/" 2>/dev/null || true
cp -r "$SCRIPT_DIR/.cursor" "$TARGET_DIR/" 2>/dev/null || true
cp -r "$SCRIPT_DIR/workpads" "$TARGET_DIR/" 2>/dev/null || true
cp "$SCRIPT_DIR/ralph.yml" "$TARGET_DIR/" 2>/dev/null || true
cp "$SCRIPT_DIR/PROMPT.md" "$TARGET_DIR/" 2>/dev/null || true
cp "$SCRIPT_DIR/TASK.md" "$TARGET_DIR/" 2>/dev/null || true
cp "$SCRIPT_DIR/.gitignore" "$TARGET_DIR/" 2>/dev/null || true
cp "$SCRIPT_DIR/SETUP_PROMPT.md" "$TARGET_DIR/" 2>/dev/null || true

# Get project description if not provided
if [ -z "$PROJECT_DESC" ]; then
    echo ""
    echo -e "${BLUE}Describe your project:${NC}"
    echo "(What are you building? Tech stack? Key features? Any decisions already made?)"
    echo ""
    echo "Enter description (press Ctrl+D when done):"
    echo "---"
    PROJECT_DESC=$(cat)
    echo "---"
fi

# Create SETUP_INPUT.md
echo -e "${GREEN}Creating SETUP_INPUT.md...${NC}"
cat > "$TARGET_DIR/SETUP_INPUT.md" << EOF
# Project Setup Input

## Project Description

$PROJECT_DESC

## Questions for Setup

Please consider:
1. What workpads should be created for this project?
2. What research is needed before implementation?
3. What are the initial setup tasks?
4. What decisions have already been made vs. need investigation?
5. Are there any specific patterns or constraints to follow?

---

*This file was generated by setup.sh. Claude will read this and SETUP_PROMPT.md to create the project structure.*
EOF

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Setup Complete!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "Files created in: $TARGET_DIR"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo ""
echo "  1. cd $TARGET_DIR"
echo "  2. git init  # if not already a git repo"
echo "  3. Run Claude Code and ask it to:"
echo ""
echo -e "     ${YELLOW}Read SETUP_PROMPT.md and SETUP_INPUT.md, then set up this project.${NC}"
echo ""
echo "  Claude will:"
echo "  - Create appropriate workpads for your project"
echo "  - Populate knowledge.md and references.md files"
echo "  - Generate initial tasks in TASK.md"
echo "  - Identify research needed"
echo "  - Create project-specific Cursor rules (if applicable)"
echo ""
echo "  4. Review and commit: git add -A && git commit -m 'Initial project setup'"
echo "  5. Start ralph: ralph"
echo ""
